<!DOCTYPE html>
<html>

    <head>
        <script src="./js/libraries/threejs/three.min.js"></script>
        <script src="./js/libraries/threejs/controls/OrbitControls.js"></script>
    </head>

    <body>
        <script>
            const url = "./files/20180527_111027.xyz";

            let scene, camera, renderer, controls;

            let pointCloud, contourSlice;

            const middlePlanePosition = 0;

            function init() {
                scene = new THREE.Scene();

                camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                camera.position.z = 5;

                renderer = new THREE.WebGLRenderer();
                renderer.setSize(window.innerWidth, window.innerHeight);
                document.body.appendChild(renderer.domElement);

                controls = new THREE.OrbitControls(camera, renderer.domElement);

                loadPointCloud();
            }

            function loadPointCloud() {
                const loader = new THREE.FileLoader();
                loader.load(url, (data) => {
                        const points = data.split('\n').map(line => line.split(' ').map(parseFloat));
                        const geometry = new THREE.BufferGeometry();
                        const positions = new Float32Array(points.flat());
                        geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
                        const material = new THREE.PointsMaterial({ color: 0xffffff, size: 0.1 });
                        pointCloud = new THREE.Points(geometry, material);
                        scene.add(pointCloud);

                        createContourSlice();
                    });
            }

            function createContourSlice() {
                const planeGeometry = new THREE.PlaneGeometry(10, 10); // Adjust size as needed
                const planeMaterial = new THREE.MeshBasicMaterial({ color: 0xff0000, side: THREE.DoubleSide, opacity: 0.5, transparent: true });
                contourSlice = new THREE.Mesh(planeGeometry, planeMaterial);
                contourSlice.position.y = middlePlanePosition;
                scene.add(contourSlice);

                projectPointCloudOntoSlice();
            }

            function projectPointCloudOntoSlice() {
                const vertices = pointCloud.geometry.attributes.position.array;
                const sliceVertices = [];
                for (let i = 0; i < vertices.length; i += 3) {
                    const x = vertices[i];
                    const y = vertices[i + 1];
                    const z = vertices[i + 2];

                    const projectedPoint = new THREE.Vector3(x, middlePlanePosition, z);
                    sliceVertices.push(projectedPoint.x, projectedPoint.y, projectedPoint.z);
                }

                const sliceGeometry = new THREE.BufferGeometry();
                sliceGeometry.setAttribute('position', new THREE.BufferAttribute(new Float32Array(sliceVertices), 3));

                contourSlice.geometry.dispose();
                contourSlice.geometry = sliceGeometry;
            }

            function animate() {
                requestAnimationFrame(animate);
                controls.update();
                renderer.render(scene, camera);
            }

            init();
            animate();
        </script>
    </body>

</html>

